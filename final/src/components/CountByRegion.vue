<template>
    <div class="container">
        <div class="row">
            <div class="col">
                <h3>Biking Station Count by region</h3>
                <p class="alert alert-primary">
                    This graph portraits accumulative bike usage against region. You can find that Venice is even more popular than DTLA although it is an new area.
                    Please notice that only DTLA has all data for all months.
                </p>
                <p class="alert alert-info">Move your mouse on the lines to see more details.</p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <select v-on:change="onChange" id="select">
                    <option value="0">Jul 2016</option>
                    <option value="1">Aug 2016</option>
                    <option value="2">Sep 2016</option>
                    <option value="3">Oct 2016</option>
                    <option value="4">Nov 2016</option>
                    <option value="5">Dec 2016</option>
                    <option value="6">Jan 2017</option>
                    <option value="7">Feb 2017</option>
                    <option value="8">Mar 2017</option>
                    <option value="9">Apr 2017</option>
                    <option value="10">May 2017</option>
                    <option value="11">Jun 2017</option>
                    <option value="12">Jul 2017</option>
                    <option value="13">Aug 2017</option>
                    <option value="14">Sep 2017</option>
                    <option value="15">Oct 2017</option>
                    <option value="16">Nov 2017</option>
                    <option value="17">Dec 2017</option>
                    <option value="18">Jan 2018</option>
                    <option value="19">Feb 2018</option>
                    <option value="20">Mar 2018</option>
                    <option value="21">Apr 2018</option>
                    <option value="22">May 2018</option>
                    <option value="23" selected>Jun 2018</option>
                </select>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col-sm-8" id="container">
                <div style="min-height: 800px !important;">
                    <svg id="pie"></svg>
                </div>
            </div>
            <div class="col-sm-4 align-top">
                <div class="card">
                    <div class="card-body">
                        <h4 id="pie-card-name" class="card-title">Monthly Bike Usage</h4>
                        <h6 class="card-subtitle mb-2 text-muted">The Average Amount of Metro Bikes Used in Regions in Each Month</h6>
                        <p id="pie-card-desc" class="card-text">Select month from dropdown box. Mouse over pie slices for detailed Information.
                            <br/>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</template>

<script>
    import * as d3 from 'd3';

    export default {
        name: "countByRegion",

        methods: {
            onChange() {
                d3.select("#pie").selectAll("*").remove();
                this.initChart();
            },
            initChart() {
                var that = this;
                d3.json("./countMonthRegionPie.json").then(function (dataset) {
                    // console.log(dataset);

                    that.region = dataset.map(function (d) {
                        return d.region
                    });
                    var color = d3.scaleOrdinal()
                        .domain(that.region)
                        .range(d3.schemeCategory10);
                    var sel = document.getElementById('select');
                    var value = sel.options[sel.selectedIndex].value

                    if (value == -1) {
                        var data = [{region: "DTLA", average: "1"}, {region: "Pasadena", average: "1"}, {region: "PortOfLA", average: "1"}, {region: "Venice", average: "1"}]
                    } else {
                        var data = dataset[value].count;
                    }

                    that.diameter = parseInt(d3.select('#container').property('clientWidth'));
                    if (that.diameter > 800) {
                        that.diameter = 800
                    }

                    that.radiusOver = that.diameter / 2,
                        that.radius = that.radiusOver *.75;
                   
                    var svg = d3.select("#pie")
                        .attr("class", "pie");
                    var g = svg.append("g")
                        .attr('id', 'wholeG')
                        .attr("transform", "translate(" + that.diameter / 2 + "," + that.diameter / 2 + ")");
                    var pie = d3.pie()  //pie generator
                        .value(function (d) {
                            return d.average;
                        });

                    that.path = d3.arc()
                        .outerRadius(that.radius)
                        .innerRadius(0);  //make != 0 for a donut chart
                      //make != 0 for a donut chart
                    that.pathOver = d3.arc()
                        .outerRadius(that.radiusOver)
                        .innerRadius(0);
                    that.label = d3.arc()
                        .outerRadius(that.radius / 3)
                        .innerRadius(that.radius);
                    that.labelOver = d3.arc()
                        .outerRadius(that.radiusOver / 3)
                        .innerRadius(that.radiusOver);
                    that.arc = g.selectAll(".arc")
                        .data(pie(data))  //use pie generator to create the data needed for the each slice of the pie
                        .enter().append("g")
                        .attr("class", function (d) {
                            return d.data.region;
                        })

                    that.slice = that.arc.append("path")  //for each slide use arc path generator to draw the pie
                        .attr("d", that.path)
                        .attr("class", "slice")
                        .attr("fill", function (d) {
                            return color(d.data.region);
                        });  //get data from node (select and $0.__data__ in console)
                    that.arc.append("text")  //for each slide use label path generator to place the text
                        .attr("class", "text")
                        .attr("transform", function (d) {
                            var midAngle = d.endAngle < Math.PI ? d.startAngle / 2 + d.endAngle / 2 : d.startAngle / 2 + d.endAngle / 2 + Math.PI;
                            return "translate(" + that.label.centroid(d)[0] + "," + that.label.centroid(d)[1] + ") rotate(-90) rotate(" + (midAngle * 180 / Math.PI) + ")";
                        })
                        .attr('text-anchor', 'middle')
                        .attr('fill', 'black')
                        // .attr("dy", "0.35em")
                        .style("font-size", that.radius / 10)
                        .text(function (d) {
                            return d.data.region;
                        });
                    var sel = document.getElementById('select');
                    var text = sel.options[sel.selectedIndex].text
                    if (value != -1) {
                        that.slice.on("mouseover", function (d) {
                            d3.select('#pie-card-name').html(d.data.region);
                            d3.select('.card-subtitle').html(text);
                            d3.select('#pie-card-desc').html(d.data.average + ' bikes per station<br/>');
                            d3.selectAll('.slice')
                                .style('opacity', 0.5);
                            d3.select(this).transition()
                                .duration(300)
                                .attr("d", that.pathOver)
                                .style('opacity', 1);

                            d3.selectAll("." + d.data.region).selectAll('.text')
                                .transition()
                                .duration(300)
                                .attr("transform", function (d) {
                                    var midAngle = d.endAngle < Math.PI ? d.startAngle / 2 + d.endAngle / 2 : d.startAngle / 2 + d.endAngle / 2 + Math.PI;
                                    return "translate(" + that.labelOver.centroid(d)[0] + "," + that.labelOver.centroid(d)[1] + ") rotate(-90) rotate(" + (midAngle * 180 / Math.PI) + ")";
                                })
                                // .attr("dy", ".35em")
                                .style("font-size", that.radiusOver / 10)
                        })
                            .on("mouseout", function () {
                                d3.select('#pie-card-name').html('Monthly Bike Usage');
                                d3.select('.card-subtitle').html('The Average Amount of Metro Bike Used in Regions in Each Month');
                                d3.select('#pie-card-desc').html('Mouse over pie slices for detailed information.<br/>');
                                d3.selectAll('.slice')
                                    .style('opacity', 1);
                                d3.select(this).transition()
                                    .duration(300)
                                    .attr("d", that.path);

                                d3.selectAll('.text')
                                    .transition()
                                    .duration(300)
                                    .attr("transform", function (d) {
                                        var midAngle = d.endAngle < Math.PI ? d.startAngle / 2 + d.endAngle / 2 : d.startAngle / 2 + d.endAngle / 2 + Math.PI;
                                        return "translate(" + that.label.centroid(d)[0] + "," + that.label.centroid(d)[1] + ") rotate(-90) rotate(" + (midAngle * 180 / Math.PI) + ")";
                                    })
                                    // .attr("dy", ".35em")
                                    .style("font-size", that.radius / 10);
                            });
                    }

                    function resize() {
                        try {
                            that.diameter = parseInt(d3.select('#container').property('clientWidth'));
                            if (that.diameter > 800) {
                                that.diameter = 800
                            }
                            that.radiusOver = that.diameter / 2;
                            that.radius = that.radiusOver * .75;


                            d3.select('#wholeG').attr("transform", "translate(" + that.diameter / 2 + "," + that.diameter / 2 + ")");

                            that.path = d3.arc()
                                .outerRadius(that.radius)
                                .innerRadius(0);  //make != 0 for a donut chart

                            that.pathOver = d3.arc()
                                .outerRadius(that.radiusOver)
                                .innerRadius(0);  //make != 0 for a donut chart

                            that.label = d3.arc()
                                .outerRadius(that.radius * 1 / 3)
                                .innerRadius(that.radius);

                            that.labelOver = d3.arc()
                                .outerRadius(that.radiusOver * 1 / 3)
                                .innerRadius(that.radiusOver);

                            svg.selectAll('.slice') //for each slide use arc path generator to draw the pie
                                .attr("d", that.path)

                            that.arc.selectAll(".text")  //for each slide use label path generator to place the text
                                .attr("transform", function (d) {
                                    var midAngle = d.endAngle < Math.PI ? d.startAngle / 2 + d.endAngle / 2 : d.startAngle / 2 + d.endAngle / 2 + Math.PI;
                                    return "translate(" + that.label.centroid(d)[0] + "," + that.label.centroid(d)[1] + ") rotate(-90) rotate(" + (midAngle * 180 / Math.PI) + ")";
                                })
                                .style("font-size", that.radius / 10);
                        }catch (e) {
                            console.log("SB le")
                        }
                    }

                    d3.select(window).on('resize', resize);
                    // window.addEventListener('resize', resize);
                    resize();
                })
            }

        },
        mounted: function () {
            this.initChart();
        }
    }
</script>

<style scoped>
    #pie {
        width: 100%;
        height: 100%;
        position: absolute;
    }
</style>